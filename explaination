# E-Bookstore System Explanation (Frontend -> Backend)

This explains the current full flow with your latest updates.

## 1. Architecture

1. Frontend: React + Vite (`frontend/`) on Vercel
- URL: `https://e-bookstore-one.vercel.app`

2. Backend API: PHP on Railway
- Entry: `public/index.php`
- URL: `https://e-bookstorebackend-production.up.railway.app`

3. Database: Supabase PostgreSQL
- Main data: users, books, JSON cart/orders, stock/sales

Flow:
`Browser -> Frontend (Vercel) -> API (Railway) -> Supabase -> API -> Browser`

## 2. Env Setup (Production)

### Frontend (Vercel)
- `VITE_API_BASE_URL=https://e-bookstorebackend-production.up.railway.app`

### Backend (Railway)
- `DB_DRIVER=pgsql`
- `DB_HOST=aws-1-ap-northeast-1.pooler.supabase.com`
- `DB_PORT=5432`
- `DB_DATABASE=postgres`
- `DB_USERNAME=...`
- `DB_PASSWORD=...`
- `DB_SSLMODE=require`
- `JWT_SECRET=...`
- `CORS_ALLOWED_ORIGINS=http://localhost:5173,https://e-bookstore-one.vercel.app`
- `CORS_ALLOW_VERCEL_PREVIEWS=true`
- `COOKIE_SAMESITE=None`
- `COOKIE_PATH=/`
- `COOKIE_DOMAIN=`

## 3. Authentication

Auth mode now:
- Primary: `Authorization: Bearer <token>`
- Fallback: `auth_token` cookie

### Login
`POST /api/login`
- Validates customer/admin credentials
- Returns JSON: `message`, `token`, `user`
- Also sets cookie fallback

### Frontend token storage
- `Remember me` checked -> `localStorage`
- unchecked -> `sessionStorage`

### Middleware validation order
1. Bearer token
2. Cookie

### Logout
`POST /api/logout`
- clears cookie backend-side
- frontend clears local/session auth state

## 4. Homepage Behavior

Homepage books come from:
- `GET /api/books`

Each card now shows:
- Title
- Author
- Category
- Description
- Stock
- Sales
- Rating

### Responsive layout
- Phone: 2 cards per row
- iPad/tablet: 3 cards per row
- Desktop XL: 4 cards per row

### Search + Filter
- Search box supports matching by:
  - book name
  - author
  - category
- Search scope options:
  - All
  - Book Name
  - Author
  - Category
- Sorting filter options:
  - Categories
  - Authors
  - Price
  - Trending (Most Sales)
- Search highlights matched text in card fields.

### Loading UX
- Skeleton loaders are used for loading states.

## 5. Cart + Orders

### Cart endpoints
- `GET /api/cart`
- `POST /api/cart/add`
- `PUT /api/cart/quantity`
- `DELETE /api/cart/remove`

### Checkout
- `POST /api/cart/checkout`

### Orders
- `GET /api/orders`
- `GET /api/orders/:orderId`

### Category hydration (important)
Old JSON cart/order items may not contain category.
Backend now hydrates missing category from `books + categories` during reads.

### Stock hydration (important)
Cart items in stored JSON can become stale if stock changes after add-to-cart.
Backend now refreshes stock from `books.stock` when returning cart items so frontend shows current stock.

### Quantity edit + validation (frontend)
Cart quantity is editable by typing directly, plus `+/-` buttons.

Validation now shows inline error under each item quantity:
- Empty input: `Quantity is required`
- Non-digit input: `Please enter digits only`
- Less than 1: `Quantity must be at least 1`
- Greater than available stock: `Only X in stock`

Invalid values are blocked from API update.

## 6. Dynamic Stock and Sales

On checkout backend now:
1. Validates requested quantity against current stock for each item
2. Runs DB transaction
3. Deducts stock from `books.stock`
4. Increments sales (`books.sales_count` or fallback `books.sold`)
5. Saves order and clears cart

If any item fails stock check, transaction is rolled back.

## 7. Why Sales Might Still Show 0

If sales is still zero after deploy, usually one of these:
1. Railway running old backend deployment
2. Books table has no `sales_count` or `sold` column
3. Column exists but values are all 0 and no new checkout happened yet

Recommended SQL:

```sql
ALTER TABLE books ADD COLUMN IF NOT EXISTS sales_count INTEGER NOT NULL DEFAULT 0;
SELECT id, title, stock, sales_count FROM books ORDER BY id;
```

Then place a real checkout to verify auto-increment.

## 8. Quick Verification Checklist

1. API health:
- `GET /api/books` returns JSON with `category_name` and `sales_count`

2. Auth:
- login returns `token`
- protected pages still work after refresh

3. Cart/Orders:
- category appears in cart items and order detail items
- stock appears in cart items and reflects current DB stock

4. Inventory:
- checkout reduces stock and increases sales

5. Frontend:
- search + search-scope + highlight work correctly
- quantity edit shows validation errors for invalid input
